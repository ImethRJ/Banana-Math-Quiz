<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Math Quiz - Top Players</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/highscore.css">
</head>
<body>
    <div class="login-section">
        <button id="loginButton">Login</button>
        <button id="homeButton">Home</button>
        <div id="authStatus" class="auth-status">Not logged in</div>
    </div>

    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h1>üçåLeaderboard - Top Playersüçå</h1>
        </div>
        <div id="leaderboard-content">
            <div class="loading">Please log in to view the leaderboard...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the Firebase SDK modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            GoogleAuthProvider
        } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            getDocs, 
            orderBy, 
            limit 
        } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7js4aE8oDH9HPlQMJawxyDP3DwiY7xHc",
            authDomain: "banana-quiz-6bf99.firebaseapp.com",
            projectId: "banana-quiz-6bf99",
            storageBucket: "banana-quiz-6bf99.appspot.com",
            messagingSenderId: "18102598554",
            appId: "1:18102598554:web:cac2591308e3b466d59823"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM elements
        const loginButton = document.getElementById('loginButton');
        const authStatus = document.getElementById('authStatus');
        const homeButton = document.getElementById('homeButton');
        const leaderboardContent = document.getElementById('leaderboard-content');
        
        // Handle home button click
        homeButton.addEventListener('click', () => {
            window.location.href = 'home.html';
        });
        
        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in - update UI
                updateUserDisplay(user);
                
                // Update login button to log out
                loginButton.textContent = "Log Out";
                loginButton.onclick = () => {
                    signOut(auth).then(() => {
                        window.location.reload();
                    }).catch((error) => {
                        console.error("Sign out error:", error);
                    });
                };
                
                // Load leaderboard data
                loadLeaderboard();
            } else {
                // User is signed out - update UI
                authStatus.innerHTML = "Not logged in";
                
                // Update login button
                loginButton.textContent = "Login";
                loginButton.onclick = () => {
                    window.location.href = 'login.html';
                };
                
                // Show login prompt
                leaderboardContent.innerHTML = 
                    '<div class="loading">Please log in to view the leaderboard...</div>';
            }
        });
        
        // Function to update user display with profile info
        function updateUserDisplay(user) {
            let userDisplay = '';
            
            // Add avatar if available
            if (user.photoURL) {
                userDisplay += `<div class="user-avatar" style="background-image: url('${user.photoURL}')"></div>`;
            } else {
                // Display first letter of email/name as placeholder
                const initial = (user.displayName || user.email || '?').charAt(0).toUpperCase();
                userDisplay += `<div class="placeholder-avatar">${initial}</div>`;
            }
            
            // Use display name if available, otherwise use email
            const displayName = user.displayName || user.email.split('@')[0];
            userDisplay += `Logged in as: ${displayName}`;
            
            authStatus.innerHTML = userDisplay;
        }
        
        // Function to fetch and display top players
        async function loadLeaderboard() {
            leaderboardContent.innerHTML = '<div class="loading">Loading leaderboard data...</div>';
            
            try {
                // Combined approach: Get data from both collections
                const usersRef = collection(db, "users");
                const userTotalsRef = collection(db, "userTotals");
                
                // Array to store all player data
                const players = [];
                
                // 1. Get data from users collection (Google Sign-In users)
                try {
                    const usersSnapshot = await getDocs(usersRef);
                    
                    usersSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.quizProgress) {
                            players.push({
                                id: doc.id,
                                source: 'users',
                                displayName: data.displayName || (data.email ? data.email.split('@')[0] : 'Unknown Player'),
                                photoURL: data.photoURL || null,
                                highestScore: data.quizProgress.highestScore || 0,
                                totalScore: data.quizProgress.totalScore || 0,
                                gamesPlayed: data.quizProgress.completedQuizzes || 0
                            });
                        }
                    });
                    
                    console.log(`Loaded ${players.length} players from users collection`);
                } catch (error) {
                    console.error("Error loading data from users collection:", error);
                }
                
                // 2. Get data from userTotals collection (traditional users)
                try {
                    const userTotalsSnapshot = await getDocs(userTotalsRef);
                    
                    userTotalsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const email = data.userEmail || 'Unknown Player';
                        const displayName = data.userEmail ? email.split('@')[0] : 'Unknown Player';
                        
                        // Check if this user already exists in the players array
                        // This prevents duplicates if a user is in both collections
                        const existingPlayerIndex = players.findIndex(p => 
                            (p.displayName.toLowerCase() === displayName.toLowerCase()) || 
                            (data.userId && p.id === data.userId)
                        );
                        
                        if (existingPlayerIndex !== -1) {
                            // User exists - update scores if the userTotals scores are higher
                            const existingPlayer = players[existingPlayerIndex];
                            
                            if ((data.highestScore || 0) > existingPlayer.highestScore) {
                                existingPlayer.highestScore = data.highestScore || 0;
                            }
                            
                            if ((data.totalScore || 0) > existingPlayer.totalScore) {
                                existingPlayer.totalScore = data.totalScore || 0;
                            }
                            
                            if ((data.gamesPlayed || 0) > existingPlayer.gamesPlayed) {
                                existingPlayer.gamesPlayed = data.gamesPlayed || 0;
                            }
                        } else {
                            // New user - add to players array
                            players.push({
                                id: doc.id,
                                source: 'userTotals',
                                displayName: displayName,
                                photoURL: null,
                                highestScore: data.highestScore || 0,
                                totalScore: data.totalScore || 0,
                                gamesPlayed: data.gamesPlayed || 0
                            });
                        }
                    });
                    
                    console.log(`Total players after merging collections: ${players.length}`);
                } catch (error) {
                    console.error("Error loading data from userTotals collection:", error);
                }
                
                if (players.length === 0) {
                    leaderboardContent.innerHTML = '<div class="error">No player data found in either collection.</div>';
                    return;
                }
                
                // Sort players by highest score in descending order
                players.sort((a, b) => b.highestScore - a.highestScore || b.totalScore - a.totalScore);
                
                // Take top 5 players
                const topPlayers = players.slice(0, 5);
                
                console.log("Top 5 players:", topPlayers);
                
                // Create table structure
                let tableHTML = `
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Highest Score</th>
                                <th>Total Score</th>
                                <th>Games</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add each player to the table
                topPlayers.forEach((player, index) => {
                    // Create badge for top 3 players
                    let badge = '';
                    if (index === 0) badge = '<span class="badge gold">1st</span>';
                    else if (index === 1) badge = '<span class="badge silver">2nd</span>';
                    else if (index === 2) badge = '<span class="badge bronze">3rd</span>';
                    
                    // Player avatar
                    let avatarHTML = '';
                    if (player.photoURL) {
                        avatarHTML = `<div class="user-avatar" style="background-image: url('${player.photoURL}')"></div>`;
                    } else {
                        const initial = player.displayName.charAt(0).toUpperCase();
                        avatarHTML = `<div class="placeholder-avatar">${initial}</div>`;
                    }
                    
                    tableHTML += `
                        <tr>
                            <td class="rank">#${index + 1}</td>
                            <td class="username">
                                <div style="display: flex; align-items: center;">
                                    ${avatarHTML}
                                    ${player.displayName}${badge}
                                </div>
                            </td>
                            <td class="score">${player.highestScore}</td>
                            <td class="score">${player.totalScore}</td>
                            <td class="score">${player.gamesPlayed}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                leaderboardContent.innerHTML = tableHTML;
                
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardContent.innerHTML = `
                    <div class="error">
                        <p>Error loading leaderboard data: ${error.message}</p>
                        <p>This might be due to insufficient permissions or a database issue.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>